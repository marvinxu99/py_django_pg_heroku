{% load static %}
{% load humanize %}
<div class="row">
  <img class="m-1 winter-logo2" src="{% static 'img/winter-logo-sm-white.png' %}">
  <div class="ml-1">
    <a href="#" id="project-code-val">WINN 1.0 -></a>
    <a href="{% url 'itrac:issue_detail' issue.id %}">{{ issue.issue_id }}</a>
    <div class="h3">{{ issue.title }}</div>
  </div>
</div>
<div>
  <a class="btn btn-sm btn-outline-info" href="{% url 'itrac:edit_issue' issue.id %}">Edit Issue</a>
  <a class="btn btn-sm btn-outline-info" href="{% url 'itrac:new_comment' issue.id %}">New Comment</a>
  <a class="btn btn-sm btn-outline-info mx-3" href="{% url 'itrac:save_issue' issue.id %}">Add to Favorite</a>
  <button class="btn btn-sm btn-outline-info dropdown-toggle" type="button" id="dropdownStatus" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
    Change Status to: <span class="caret"></span>
  </button>
  <ul class="dropdown-menu" aria-labelledby="dropdownStatus">
    <li><a class="dropdown-item js_issue_status" url="{% url 'itrac:change_status' issue.id %}" value="OPEN">Open</a></li>
    <li><a class="dropdown-item js_issue_status" url="{% url 'itrac:change_status' issue.id %}" value="INVESTIGATE">Investigate</a></li>
    <li><a class="dropdown-item js_issue_status" url="{% url 'itrac:change_status' issue.id %}" value="TRIAGE">Await approval</a></li>
    <li><a class="dropdown-item js_issue_status" url="{% url 'itrac:change_status' issue.id %}" value="BUILD_IN_PROGRESS">Build in progress</a></li>
    <li><a class="dropdown-item js_issue_status" url="{% url 'itrac:change_status' issue.id %}" value="VALIDATING">Validate in progress</a></li>
    <li><a class="dropdown-item js_issue_status" url="{% url 'itrac:change_status' issue.id %}" value="COMPLETE">Complete</a></li>
    <li><a class="dropdown-item js_issue_status" url="{% url 'itrac:change_status' issue.id %}" value="CLOSED">Closed</a></li>
  </ul>
</div>
<div class="mt-3">
  <div class="d-flex align-items-center">
    <a class="js-collapse-toggle" data-toggle="collapse" href="#collapse_details">
      <i class="fa fa-minus-circle" style="font-size:12px;color:gray"></i>
    </a>
    <strong>Details</strong>
  </div>
  <div class="collapse js-collapse-details ml-3" id="collapse_details">
    <div class="row">
      <div class="col-md-2">Type:</div>
      <div class="col-md-4">{{ issue.get_issue_type_display }}</div>
      <div class="col-md-2">Status:</div>
      <div class="col-md-4" id="issue_status_display">{{ issue.get_status_display }}</div>
      <div class="w-100"></div>

      <div class="col-md-2">Created:</div>
      <div class="col-md-4" title="{{ issue.created_date }}">{{ issue.created_date|naturaltime }}</div>
      <div class="col-md-2">Assigned to:</div>
      <div class="col-md-4">{{ issue.assignee }}</div>
      <div class="w-100"></div>

      <div class="col-md-2">Updated:</div>
      <div class="col-md-4" title="{{ issue.updated_date }}">{{ issue.updated_date|naturaltime }}</div>
      <div class="col-md-2">Reported by:</div>
      <div class="col-md-4">{{ issue.author }}</div>
      <div class="w-100"></div>

      <div class="col-md-2">Resolved:</div>
      <div class="col-md-4">{{ issue.is_resolved|yesno:"Yes,No" }}</div>
      <div class="col-md-2">Upvotes:</div>
      <div class="col-md-4">{{ issue.upvotes }}
          {% if issue.issue_type == "BUG" %}
            <a class="btn" href="{% url 'itrac:upvote' issue.id %}">[thumb_up]</a>
          {% endif %}
      </div>
      <div class="w-100"></div>
            
      <div class="col-md-2">Resolved Date:</div>
      <div class="col-md-4" title="{{ issue.resolved_date|default_if_none:'' }}">{{ issue.resolved_date|default_if_none:""|naturaltime }}</div>
      <div class="col-md-2"></div>
      <div class="col-md-4"></div>
    </div>      
    <div class="d-flex align-items-baseline mt-3">
      <div><span class="font-weight-bold">Tags:</span></div>
      <div class="d-flex">
          {% for tag in issue.tags.all %}
            <a class="ml-1 btn btn-sm" href="{% url 'itrac:issues_with_tag' %}?tag={{ tag }}"> {{ tag.title }}</a>
          {% endfor %}
      </div>
    </div>
  </div>
</div>
<div class="mt-3">
  <div class="d-flex align-items-center">
    <a class="js-collapse-toggle" data-toggle="collapse" href="#collapse_description">
      <i class="fa fa-minus-circle" style="font-size:12px;color:gray"></i>
    </a>
    <strong>Description</strong>
  </div>
  <div class="collapse js-collapse-details ml-3" id="collapse_description">
    <p>{{ issue.description }}</p>
  </div>
</div>
<div>
  {% if issue.image %}
    <img class="materialboxed" src="{{ MEDIA_URL }}{{ issue.image }}" alt="Issue Image" style="width:100%;height:450px;">
  {% endif %}
</div>

  {% if issue.issue_type == "FEATURE" %}
  <h5>Purchase Feature Upvotes</h5>
  <form method="post" action="{% url 'add_to_cart' issue.id %}">
      {% csrf_token %}
      <div class="input-group">
          <input name='quantity' type="number" min="1" max="99" class="form-control" placeholder="Quantity">
          <button class="btn waves-effect waves-light" type="submit" name="action" onclick="M.toast({html: 'Added to Cart!'})">Add to Cart
              </button>
      </div>
  </form>
  {% endif %}

<div class="mt-3">
  <div class="d-flex align-items-center">
    <a class="js-collapse-toggle" data-toggle="collapse" href="#collapse_comments">
      <i class="fa fa-minus-circle" style="font-size:12px;color:gray"></i>
    </a>
    <strong>Comments</strong>
  </div>
  <div class="collapse js-collapse-details js_comment_list ml-3" id="collapse_comments">
    <ul class="list-group list-group-flush comment-list">
    {% for comment in comments %}
    <li  class="list-group-item js_comment_item">
      <div class="d-flex">
        <div class="js-collapse-toggle" data-toggle="collapse" href="#collapse_comment{{comment.id}}">
            <i class="fa fa-minus-circle" style="font-size:12px;color:gray"></i>
        </div>
        <div>
            <strong>{{ comment.author }}</strong> 
            added a comment - <span title="{{comment.created_date}}">{{ comment.created_date|naturaltime }}</span> 
            {% if comment.updated_date != comment.created_date %} 
              <span title="{{comment.updated_date}}">(edited at {{ comment.updated_date|naturaltime }})</span> 
            {% endif %}
            {% if user == comment.author %}
            <a class="btn btn-sm" href="{% url 'itrac:edit_comment' issue.id comment.id %}"><i class="fa fa-edit"></i></a>
            <button type="button" class="btn btn-sm" data-toggle="modal" data-target="#confirmDeleteComment"
                data-url="{% url 'itrac:delete_comment' issue.id comment.id %}"
                data-comment='"{{ comment.comment|truncatechars:60 }}"'><i class="fa fa-trash" aria-hidden="true"></i>
            </button>
            {% endif %}
        </div>
      </div>
      <div class="collapse js-collapse-details ml-3" id="collapse_comment{{comment.id}}">
        <p>{{ comment.comment }}</p>
      </div>
    </li>
    {% endfor %}
    </ul>
    <div id="new_comment_btn_div" class="my-3">
      <a class="btn btn-sm btn-outline-info" href="{% url 'itrac:new_comment' issue.id %}">New Comment</a>
    </div>
  </div>
</div>
<div class="modal fade" id="confirmDeleteComment" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteCommentLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteCommentLabel">Confirm to delete</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this comment?</p>
        <p id="comment_to_delete" class="text-muted ml-3"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <a id="confirm_delete_comment" class="btn btn-sm btn-outline-secondary" href="#" role="button">Delete Comment</a>
      </div>
    </div>
  </div>
</div>
<script src="{% static 'js/winn_utils.js' %}"></script>
<script>
  $('#collapse_comments ul li').hover(function(){
      $(this).css('background-color', 'lightblue');
  }, function(){
      $(this).css('background-color', '');
  });

  // Confirm to deletet comment
  $('#confirmDeleteComment').on('show.bs.modal', function (event) {
    const button = $(event.relatedTarget);     // Button that triggered the modal
    const data = button.data('url');           // Extract info from data-* attributes
    const comment = button.data('comment');
    $("#confirm_delete_comment").attr("href", data);
    $("#comment_to_delete").html(comment);
  });
 
  // Change issue status
  $(".js_issue_status").click(function(event) {
    const status = $(event.target).attr('value');
    const url = $(event.target).attr('url');
    const csrftoken = getCookie('csrftoken');

    $.ajax({
      type: "POST",
      url: url,
      data: {
        'new_status': status
      },
      headers: {'X-CSRFToken': '{{ csrf_token }}'},
      // beforeSend: function(xhr, settings) {
      //       xhr.setRequestHeader("X-CSRFToken", csrftoken);
      // },
      success: function (data) {
        if (data.status === "S") {
          $('#issue_status_display').html(data.issue_status);
        }
      }
    });

    return false; 
  });

</script>
    
